---
title: "702 final proj code"
author: "Zoe Zhu"
date: "10/27/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F)
knitr::opts_chunk$set(include =  F)
knitr::opts_chunk$set(fig.align="center")
knitr::opts_chunk$set(out.width = '50%')
```

```{r, message=FALSE}
library(tseries)
library(forecast)
library(astsa)
library(ggplot2)
library(Metrics)
```

```{r}
# Import data
oil <- read.csv("D:/MIDS/fall 2020/702 modeling/dataset/eia crude oil.csv",header=TRUE, col.names = c('date','production','price'),nrows = 1208)
oil$date <- as.Date(paste(oil$date,"-01",sep=""),format="%B-%Y-%d")
```

#### Check oil production & oil price

```{r}
# make production a time series object
oil_production = ts(oil$production)
ts.plot(oil_production,col='red3')
oil_price = ts(oil$price[649:1208])
ts.plot(oil_price,col='blue3')
```

```{r}
# cannot tell which arima model
acf(oil_production);pacf(oil_production)
acf(oil_price);pacf(oil_price)
```

```{r}
# not stationary
adf_test <- adf.test(oil_price,alternative = 'stationary')
print(adf_test)

kpss_test <- kpss.test(oil_price)
print(kpss_test)
```

#### Add oil prodution as a predictor for oil price

```{r}
# oil price as response, oil production as predictor, subset for valid rows
# Remove time after march 2020 - the influence of covid-19
oil_data = oil[649:1202,]
rownames(oil_data) <- NULL
```

```{r}
ggplot(oil_data, aes(x=production, y=price)) +
  geom_point(alpha = .5,colour="blue4") +
  geom_smooth(method="lm",col="red3") +
  labs(title="Oil price vs Production")
```

```{r}
tsprice <- ts(oil_data$price)
ts.plot(tsprice,col="blue4")
```

#### Fit a linear regression using production as a predictor

```{r}
reg <- lm(price ~ production, data = oil_data)
summary(reg)
ggplot(oil_data, aes(x=production, y=reg$residual)) +
  geom_point(alpha = .5,colour="blue4") +
  geom_hline(yintercept=0,col="red3") + labs(title="Residuals vs production")

#plot(reg)
```

```{r}
ggplot(oil_data, aes(x=date, y=reg$residual)) +
  geom_point(alpha = .5,colour="blue4") +
  geom_hline(yintercept=0,col="red3") + labs(title="Residuals vs Month-Year")
```

```{r}
acf(reg$resid)
#acf(reg$resid,plot=F)
pacf(reg$resid)
#(regmelanoma$resid,plot=F)
```

#### Fit a linear regression with production & time

```{r}
reg2 <- lm(price ~ production + date, data = oil_data)
summary(reg2)

ggplot(oil_data, aes(x=production, y=reg2$residual)) +
  geom_point(alpha = .5,colour="blue4") +
  geom_hline(yintercept=0,col="red3") + labs(title="Residuals vs production")

ggplot(oil_data, aes(x=date, y=reg2$residual)) +
  geom_point(alpha = .5,colour="blue4") +
  geom_hline(yintercept=0,col="red3") + labs(title="Residuals vs Month-Year")
```

```{r}
tsresid2 <- ts(reg2$residual)
ts.plot(tsresid2,col="blue4")

adf_test<- adf.test(tsresid2,alternative = 'stationary')
print(adf_test)

kpss_test <- kpss.test(tsresid2)
print(kpss_test)
```

#### Try previous production

```{r}
prevprod <- c(NA, oil_data$production[1:553])
prevprice <- c(NA, oil_data$price[1:553])

oil_data$prevprod <- prevprod
oil_data$prvprice <- prevprice

oil_data$dprod <- oil_data$production - prevprod
oil_data$dprice <- oil_data$price - prevprice

oil2 = oil_data[2:554,]
rownames(oil2) <- NULL
```

#### Add indicator for great recession dec 2007-jun 2009

```{r}
oil2$recession <- 0
oil2$recession[407:425] <- 1
oil2$recession = factor(oil2$recession)
```

#### Add indicator for global supply glut dec jun 2014-dec 2016(OPEC agreement)
```{r}
oil2$glut <- 0
oil2$glut[485:515] <- 1
oil2$glut = factor(oil2$glut)
```

#### Fit a linear regression with prevprod & time

```{r}
reg3 <- lm(price ~ prevprod + date, data = oil2)
summary(reg3)

ggplot(oil2, aes(x=prevprod, y=reg3$residual)) +
  geom_point(alpha = .5,colour="blue4") +
  geom_hline(yintercept=0,col="red3") + labs(title="Residuals vs previous production")

ggplot(oil2, aes(x=date, y=reg3$residual)) +
  geom_point(alpha = .5,colour="blue4") +
  geom_hline(yintercept=0,col="red3") + labs(title="Residuals vs Month-Year")
```

```{r}
# still not stationary
tsresid3 <- ts(reg3$residual)
ts.plot(tsresid3,col="blue4")

adf_test<- adf.test(tsresid3,alternative = 'stationary')
print(adf_test)

kpss_test <- kpss.test(tsresid3)
print(kpss_test)
```

```{r}
#auto.arima(oil2$price,xreg = cbind(oil2$production))
#auto.arima(oil2$price,xreg = cbind(oil2$production,oil2$date))
#auto.arima(oil2$price,xreg = cbind(oil2$prevprod,oil2$date))
```

#### Differencing + all vars
```{r}
Box.test(diff(tsresid3), lag=10, type="Ljung-Box")
```

```{r}
# first order differencing
dreg <- lm(dprice ~ dprod + date + recession + glut, data = oil2)

ggplot(oil2, aes(x=dprod, y=dreg$residual)) +
  geom_point(alpha = .5,colour="blue4") +
  geom_hline(yintercept=0,col="red3") + labs(title="Residuals vs Production in First order difference")

ggplot(oil2, aes(x=date, y=dreg$residual)) +
  geom_point(alpha = .5,colour="blue4") +
  geom_hline(yintercept=0,col="red3") + labs(title="Residuals vs Month-Year in First order difference")
```

```{r}
tsresid4 <- ts(dreg$residual)
ts.plot(tsresid4,col="blue4")

adf_test<- adf.test(tsresid4,alternative = 'stationary')
print(adf_test)

kpss_test <- kpss.test(tsresid4)
print(kpss_test)
```

```{r}
acf(dreg$resid);pacf(dreg$resid)
```
```{r}
summary(dreg)
```

```{r}
model = auto.arima(oil2$dprice,xreg = cbind(oil2$dprod,oil2$date,oil2$recession,oil2$glut))
```

```{r}
plot(oil2$date,model$residuals,main = "Residuals vs Month-Year")
abline(h=0, col="red3")
```

```{r}
#par=(mfrow=c(1,2))
hist(dreg$residuals, main = "Histogram of residuals", xlab = "Residuals")
qqnorm(dreg$residuals, main = "Normal probability plot of residuals")
qqline(dreg$residuals)
```

#### Split ylast and ynew

```{r}
# refit the last 10 months
# split data
n <- length(oil2$dprice)
y_train <- oil2[1:(n-10),]
y_test <- oil2[(n-9):n,]

# fit
#model = auto.arima(oil2$dprice,xreg = cbind(oil2$dprod,oil2$date))

model <- arima(y_train$dprice, order = c(2,0,1),xreg = cbind(y_train$dprod,y_train$date,y_train$recession,y_train$glut))

# prediction
h <- 10
m <- n-h
fcast <- predict(model, n.ahead=h,newxreg = cbind(y_test$dprod,y_test$date,y_test$recession,y_test$glut))

upper <- fcast$pred+1.96*fcast$se
lower <- fcast$pred-1.96*fcast$se

fit <- fcast$pred

# plot
plot.ts(y_train$dprice, xlim =c(400,n))
polygon(x=c(m+1:h,m+h:1), y=c(upper,rev(lower)), col='lightblue', border=NA)
lines(x=m+(1:h), y=fit,col='blue')
lines(x=m+(1:h), y=y_test$dprice,col='black')
legend("top", legend =c("true","fitted"), lty=c(1, 1), col =c("black","blue"))
```

```{r}
rmse(y_test$dprice,fit)
```
